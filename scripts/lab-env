#!/usr/bin/env bash

#==============================================================================
# lab-env - systemd-nspawn container manager for namespace/cgroup experiments
#==============================================================================
#
# Automates creation and management of a systemd-nspawn Arch Linux container
# for learning Linux namespaces, cgroups, and isolation primitives.
#
# Usage:
#   lab-env create          Create and setup the container
#   lab-env destroy         Remove the container completely
#   lab-env reset           Destroy and recreate from scratch
#   lab-env shell           Enter interactive shell
#   lab-env start           Start the container
#   lab-env stop            Stop the container
#   lab-env status          Show container status
#   lab-env exec CMD...     Execute command in container
#   lab-env info            Show detailed information
#   lab-env pkg install PKG Install packages
#   lab-env pkg update      Update all packages
#
#==============================================================================

set -euo pipefail

#------------------------------------------------------------------------------
# Configuration
#------------------------------------------------------------------------------
readonly CONTAINER_NAME="miniarch"
readonly CONTAINER_ROOT="/var/lib/machines/${CONTAINER_NAME}"
readonly NSPAWN_CONFIG="/etc/systemd/nspawn/${CONTAINER_NAME}.nspawn"
readonly CONTAINER_USER="lab"
readonly CONTAINER_USER_GROUPS="wheel"
readonly HOST_SHARED_DIR="/home/cip/.miniarch"
readonly CONTAINER_MOUNT_POINT="/shared"
readonly DEFAULT_PACKAGES="vim git sudo python iproute2 iputils"

#------------------------------------------------------------------------------
# Utility Functions
#------------------------------------------------------------------------------
log_info() {
    echo -e "\e[34m[INFO]\e[0m $*"
}

log_success() {
    echo -e "\e[32m[OK]\e[0m $*"
}

log_error() {
    echo -e "\e[31m[ERROR]\e[0m $*" >&2
}

log_warn() {
    echo -e "\e[33m[WARN]\e[0m $*"
}

check_requirements() {
    # Check for pacstrap (from arch-install-scripts)
    if ! command -v pacstrap &>/dev/null; then
        log_error "Missing required package: arch-install-scripts"
        log_info "Install with: sudo pacman -S arch-install-scripts"
        return 1
    fi

    # systemd-nspawn and machinectl come with base systemd (always installed on Arch)
    # Just verify they're actually there
    if ! command -v systemd-nspawn &>/dev/null; then
        log_error "systemd-nspawn not found (should be part of systemd package)"
        log_error "Your system may be misconfigured"
        return 1
    fi

    if ! command -v machinectl &>/dev/null; then
        log_error "machinectl not found (should be part of systemd package)"
        log_error "Your system may be misconfigured"
        return 1
    fi

    return 0
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This command must be run as root (use sudo)"
        return 1
    fi
    return 0
}

container_exists() {
    # Check nspawn config instead of container root directory
    # This works for both root and non-root users since config is world-readable
    [[ -f "$NSPAWN_CONFIG" ]]
}

container_running() {
    machinectl status "$CONTAINER_NAME" &>/dev/null
}

#------------------------------------------------------------------------------
# Core Setup Functions
#------------------------------------------------------------------------------
create_shared_dir() {
    if [[ ! -d "$HOST_SHARED_DIR" ]]; then
        log_info "Creating shared directory: $HOST_SHARED_DIR"
        mkdir -p "$HOST_SHARED_DIR"
        chown "$SUDO_USER:$SUDO_USER" "$HOST_SHARED_DIR" 2>/dev/null || true
        log_success "Created $HOST_SHARED_DIR"
    else
        log_info "Shared directory already exists: $HOST_SHARED_DIR"
    fi
}

bootstrap_base() {
    log_info "Bootstrapping minimal Arch system into $CONTAINER_ROOT"
    log_info "This may take a few minutes..."

    mkdir -p "$CONTAINER_ROOT"

    if ! pacstrap -c "$CONTAINER_ROOT" base; then
        log_error "Failed to bootstrap base system"
        return 1
    fi

    log_success "Base system bootstrapped"
}

setup_packages() {
    log_info "Installing additional packages: $DEFAULT_PACKAGES"

    systemd-nspawn -D "$CONTAINER_ROOT" --quiet pacman -Sy --noconfirm $DEFAULT_PACKAGES

    log_success "Packages installed"
}

setup_user() {
    log_info "Creating user: $CONTAINER_USER"

    # Create user with home directory and add to wheel group
    systemd-nspawn -D "$CONTAINER_ROOT" --quiet \
        useradd -m -G "$CONTAINER_USER_GROUPS" "$CONTAINER_USER" 2>/dev/null || {
        log_warn "User $CONTAINER_USER may already exist"
    }

    # Set password for user
    log_info "Set password for user '$CONTAINER_USER'"
    systemd-nspawn -D "$CONTAINER_ROOT" passwd "$CONTAINER_USER"

    log_success "User $CONTAINER_USER created"
}

setup_sudo() {
    log_info "Configuring sudo access for wheel group"

    # Uncomment %wheel ALL=(ALL:ALL) ALL line in sudoers
    systemd-nspawn -D "$CONTAINER_ROOT" --quiet \
        sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers

    log_success "Sudo configured"
}

setup_root_password() {
    log_info "Set password for root user"
    systemd-nspawn -D "$CONTAINER_ROOT" passwd root
    log_success "Root password set"
}

write_nspawn_config() {
    log_info "Writing nspawn configuration: $NSPAWN_CONFIG"

    mkdir -p "$(dirname "$NSPAWN_CONFIG")"

    cat > "$NSPAWN_CONFIG" <<EOF
[Exec]
Boot=yes
PrivateUsers=no

[Files]
Bind=${HOST_SHARED_DIR}:${CONTAINER_MOUNT_POINT}

[Network]
Private=yes
VirtualEthernet=yes
Zone=container
EOF

    log_success "Configuration written to $NSPAWN_CONFIG"

    # Create systemd drop-in to add capabilities for namespace experiments
    log_info "Creating systemd drop-in for capabilities"
    local DROP_IN_DIR="/etc/systemd/system/systemd-nspawn@${CONTAINER_NAME}.service.d"
    mkdir -p "$DROP_IN_DIR"

    cat > "$DROP_IN_DIR/capabilities.conf" <<EOF
[Service]
ExecStart=
ExecStart=/usr/bin/systemd-nspawn --quiet --keep-unit --boot --link-journal=try-guest --network-veth --machine=%i --capability=all
EOF

    systemctl daemon-reload
    log_success "Capabilities drop-in created"
}

enable_host_networking() {
    log_info "Checking host networking setup"

    if ! systemctl is-enabled systemd-networkd &>/dev/null; then
        log_info "Enabling systemd-networkd"
        systemctl enable --now systemd-networkd
    fi

    if ! systemctl is-enabled systemd-resolved &>/dev/null; then
        log_info "Enabling systemd-resolved"
        systemctl enable --now systemd-resolved
    fi

    log_success "Host networking configured"
}

enable_container_networking() {
    log_info "Configuring networking inside container"

    # Enable systemd-networkd inside the container
    systemd-nspawn -D "$CONTAINER_ROOT" --quiet systemctl enable systemd-networkd

    # Enable systemd-resolved inside the container
    systemd-nspawn -D "$CONTAINER_ROOT" --quiet systemctl enable systemd-resolved

    log_success "Container networking configured"
}

setup_container_firewall_rules() {
    log_info "Setting up firewall rules for container networking"

    # Get the container network range (usually something like 192.168.98.224/28)
    # We'll use a broad range that covers typical systemd-nspawn networks
    local CONTAINER_NETWORK="192.168.0.0/16"

    # Check if FORWARD rules already exist
    if ! iptables -C FORWARD -s "$CONTAINER_NETWORK" -j ACCEPT 2>/dev/null; then
        log_info "Adding FORWARD rule for outbound container traffic"
        iptables -I FORWARD -s "$CONTAINER_NETWORK" -j ACCEPT
    fi

    if ! iptables -C FORWARD -d "$CONTAINER_NETWORK" -m state --state ESTABLISHED,RELATED -j ACCEPT 2>/dev/null; then
        log_info "Adding FORWARD rule for return container traffic"
        iptables -I FORWARD -d "$CONTAINER_NETWORK" -m state --state ESTABLISHED,RELATED -j ACCEPT
    fi

    # Check if MASQUERADE rule exists
    if ! iptables -t nat -C POSTROUTING -s "$CONTAINER_NETWORK" -j MASQUERADE 2>/dev/null; then
        log_info "Adding NAT masquerade rule for container network"
        iptables -t nat -A POSTROUTING -s "$CONTAINER_NETWORK" -j MASQUERADE
    fi

    log_success "Firewall rules configured for container networking"
}

#------------------------------------------------------------------------------
# Command Handlers
#------------------------------------------------------------------------------
cmd_create() {
    check_root || return 1
    check_requirements || return 1

    if container_exists; then
        log_error "Container already exists at $CONTAINER_ROOT"
        log_info "Use 'lab-env destroy' first, or 'lab-env reset' to rebuild"
        return 1
    fi

    log_info "Creating container: $CONTAINER_NAME"
    echo

    # Execute setup steps
    create_shared_dir
    bootstrap_base
    setup_packages
    setup_root_password
    setup_user
    setup_sudo
    write_nspawn_config
    enable_host_networking
    enable_container_networking
    setup_container_firewall_rules

    echo
    log_success "Container '$CONTAINER_NAME' created successfully!"
    echo
    log_info "Next steps:"
    echo "  1. Enter the container:  lab-env shell"
    echo "  2. Shared directory:     $HOST_SHARED_DIR (host) â†’ $CONTAINER_MOUNT_POINT (container)"
    echo "  3. Run experiments:      All namespaces (PID, UTS, IPC, NET, USER, NS, CGROUP) available"
    echo
}

cmd_destroy() {
    check_root || return 1

    if ! container_exists; then
        log_warn "Container does not exist at $CONTAINER_ROOT"
        return 0
    fi

    log_info "Destroying container: $CONTAINER_NAME"

    # Stop if running
    if container_running; then
        log_info "Stopping running container"
        machinectl terminate "$CONTAINER_NAME" 2>/dev/null || true
        sleep 1
    fi

    # Remove container root
    log_info "Removing $CONTAINER_ROOT"
    rm -rf "$CONTAINER_ROOT"

    # Remove nspawn config
    if [[ -f "$NSPAWN_CONFIG" ]]; then
        log_info "Removing $NSPAWN_CONFIG"
        rm -f "$NSPAWN_CONFIG"
    fi

    # Remove systemd drop-in
    local DROP_IN_DIR="/etc/systemd/system/systemd-nspawn@${CONTAINER_NAME}.service.d"
    if [[ -d "$DROP_IN_DIR" ]]; then
        log_info "Removing systemd drop-in"
        rm -rf "$DROP_IN_DIR"
        systemctl daemon-reload
    fi

    log_success "Container destroyed"
}

cmd_reset() {
    check_root || return 1

    log_info "Resetting container (destroy + create)"
    echo

    cmd_destroy
    echo
    cmd_create
}

cmd_shell() {
    if ! container_exists; then
        log_error "Container does not exist. Create it first with: lab-env create"
        return 1
    fi

    # Start container if not running
    if ! container_running; then
        log_info "Starting container"
        check_root || return 1
        setup_container_firewall_rules
        machinectl start "$CONTAINER_NAME"
        sleep 2
    fi

    log_info "Entering shell as $CONTAINER_USER@$CONTAINER_NAME"
    exec machinectl shell "${CONTAINER_USER}@${CONTAINER_NAME}"
}

cmd_start() {
    check_root || return 1

    if ! container_exists; then
        log_error "Container does not exist"
        return 1
    fi

    if container_running; then
        log_warn "Container is already running"
        return 0
    fi

    log_info "Starting container: $CONTAINER_NAME"
    setup_container_firewall_rules
    machinectl start "$CONTAINER_NAME"
    log_success "Container started"
}

cmd_stop() {
    check_root || return 1

    if ! container_running; then
        log_warn "Container is not running"
        return 0
    fi

    log_info "Stopping container: $CONTAINER_NAME"
    machinectl terminate "$CONTAINER_NAME"
    log_success "Container stopped"
}

cmd_status() {
    if ! container_exists; then
        echo "Container: $CONTAINER_NAME"
        echo "Status: NOT CREATED"
        echo
        echo "Create with: lab-env create"
        return 0
    fi

    echo "Container: $CONTAINER_NAME"
    echo "Location: $CONTAINER_ROOT"

    if container_running; then
        echo "Status: RUNNING"
        echo
        machinectl status "$CONTAINER_NAME" --no-pager | head -20
    else
        echo "Status: STOPPED"
        echo
        echo "Start with: lab-env start"
        echo "Or enter with: lab-env shell (auto-starts)"
    fi
}

cmd_info() {
    if ! container_exists; then
        log_error "Container does not exist"
        return 1
    fi

    echo "=== Container Information ==="
    echo "Name:           $CONTAINER_NAME"
    echo "Root:           $CONTAINER_ROOT"
    echo "Config:         $NSPAWN_CONFIG"
    echo "User:           $CONTAINER_USER"
    echo "Shared (host):  $HOST_SHARED_DIR"
    echo "Shared (cont):  $CONTAINER_MOUNT_POINT"
    echo

    if container_running; then
        echo "Status:         RUNNING"
    else
        echo "Status:         STOPPED"
    fi

    echo
    echo "Disk usage:"
    du -sh "$CONTAINER_ROOT" 2>/dev/null || echo "  (unable to calculate)"

    if [[ -f "$NSPAWN_CONFIG" ]]; then
        echo
        echo "=== nspawn Configuration ==="
        cat "$NSPAWN_CONFIG"
    fi
}

cmd_exec() {
    if ! container_exists; then
        log_error "Container does not exist"
        return 1
    fi

    if [[ $# -eq 0 ]]; then
        log_error "Usage: lab-env exec COMMAND [ARGS...]"
        return 1
    fi

    # Start container if not running
    if ! container_running; then
        log_info "Starting container"
        check_root || return 1
        setup_container_firewall_rules
        machinectl start "$CONTAINER_NAME"
        sleep 2
    fi

    exec machinectl shell "${CONTAINER_USER}@${CONTAINER_NAME}" /usr/bin/env "$@"
}

cmd_pkg() {
    local subcmd="${1:-}"
    shift || true

    case "$subcmd" in
        install)
            if [[ $# -eq 0 ]]; then
                log_error "Usage: lab-env pkg install PACKAGE [PACKAGE...]"
                return 1
            fi

            check_root || return 1

            if ! container_exists; then
                log_error "Container does not exist"
                return 1
            fi

            log_info "Installing packages: $*"

            if container_running; then
                # Container is running - use machinectl
                if machinectl shell "root@${CONTAINER_NAME}" /usr/bin/pacman -S --noconfirm "$@"; then
                    log_success "Packages installed"
                else
                    log_error "Package installation failed"
                    return 1
                fi
            else
                # Container is stopped - use systemd-nspawn
                if systemd-nspawn -D "$CONTAINER_ROOT" --quiet pacman -S --noconfirm "$@"; then
                    log_success "Packages installed"
                else
                    log_error "Package installation failed"
                    return 1
                fi
            fi
            ;;

        update)
            check_root || return 1

            if ! container_exists; then
                log_error "Container does not exist"
                return 1
            fi

            log_info "Updating all packages"

            if container_running; then
                # Container is running - use machinectl
                if machinectl shell "root@${CONTAINER_NAME}" /usr/bin/pacman -Syu --noconfirm; then
                    log_success "Packages updated"
                else
                    log_error "Package update failed"
                    return 1
                fi
            else
                # Container is stopped - use systemd-nspawn
                if systemd-nspawn -D "$CONTAINER_ROOT" pacman -Syu --noconfirm; then
                    log_success "Packages updated"
                else
                    log_error "Package update failed"
                    return 1
                fi
            fi
            ;;

        *)
            log_error "Unknown subcommand: $subcmd"
            echo "Usage:"
            echo "  lab-env pkg install PACKAGE..."
            echo "  lab-env pkg update"
            return 1
            ;;
    esac
}

show_help() {
    cat <<EOF
lab-env - systemd-nspawn container manager for namespace/cgroup experiments

USAGE:
    lab-env COMMAND [ARGS...]

COMMANDS:
    create          Create and setup the container
    destroy         Remove the container completely
    reset           Destroy and recreate from scratch
    shell           Enter interactive shell as '$CONTAINER_USER' user
    start           Start the container (via machinectl)
    stop            Stop the container
    status          Show container status
    exec CMD...     Execute command in container as '$CONTAINER_USER'
    info            Show detailed container information
    pkg install PKG Install packages in container
    pkg update      Update all packages in container
    help            Show this help message

CONTAINER DETAILS:
    Name:           $CONTAINER_NAME
    Root:           $CONTAINER_ROOT
    User:           $CONTAINER_USER
    Shared (host):  $HOST_SHARED_DIR
    Shared (cont):  $CONTAINER_MOUNT_POINT

REQUIREMENTS:
    - arch-install-scripts (provides pacstrap)
    - systemd (provides systemd-nspawn, machinectl - already installed on Arch)

EXAMPLES:
    # First time setup
    sudo pacman -S arch-install-scripts
    sudo lab-env create

    # Enter the container
    lab-env shell

    # Reset after breaking things
    sudo lab-env reset

    # Install additional packages
    sudo lab-env pkg install strace rust

    # Run a command
    lab-env exec python /shared/my_script.py

EOF
}

#------------------------------------------------------------------------------
# Main
#------------------------------------------------------------------------------
main() {
    local cmd="${1:-}"

    case "$cmd" in
        create|destroy|reset|start|stop|status|info)
            "cmd_$cmd"
            ;;

        shell|exec)
            shift
            "cmd_$cmd" "$@"
            ;;

        pkg)
            shift
            cmd_pkg "$@"
            ;;

        help|--help|-h|"")
            show_help
            ;;

        *)
            log_error "Unknown command: $cmd"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@"
